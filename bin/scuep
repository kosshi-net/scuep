#!/bin/sh

SCUEP_VERSION="0.2"

state="$HOME/.config/scuep"; 
mkdir -p $state;

if [ ! -p "$state/pipe" ]; then
	mkfifo $state/pipe;
fi


if [ ! -f "$state/volume" ]; then
	echo "100" > $state/volume
fi

# Todo
# Autoplay toggle
# Repeat toggle
# Command to exit cleanly

if [ ! -z $1 ]; then
	file="";
	if   [ "$1" = "-" ]; then
		file=$(cat -); # Read stdin
	elif [ ! -f "$1" ]; then
		echo "Error: cannot access file: $1"
		exit 1;
	else
		file=$(cat "$1");
	fi

	echo "Playing a new playlist"
	echo 1 > $state/track_id;
	echo "$file" > $state/playlist; # Save the input playlist
	
else
	echo "Resuming";
fi;

echo "Use 'scuep-remote quit' to exit";

while [ ! -f $state/die ]; do

	mpv_options="--input-file=$state/pipe --really-quiet --no-video --no-input-terminal --volume=$(cat $state/volume)";

	track_id=$(cat $state/track_id);
	track_count=$( wc -l < $state/playlist );
	
	# Check if track id is in range
	if [ ! "$track_id" -ge 1 ] || [ ! "$track_id" -le "$track_count" ]; then
		echo "Reached end of playlist";
		track_id=1;
		echo $track_id > $state/track_id;
	fi

	url=$(head -n $track_id $state/playlist | tail -1);
	echo "$url" > $state/current_url;

	is_cue=$( echo $url | grep "cue://" );
	if [ ! -z "$is_cue" ]; then

		path="$(scuep-cue-helper path "$url")";
		
		chapter="$(scuep-cue-helper chapter "$url")";
		title="$(scuep-cue-helper title "$url")";

		echo "Playing $track_id / $track_count // $title (cue)";
		mpv "$path" --start=#$chapter --end=#$(($chapter+1)) $mpv_options;
	else
		filename=$(echo "$url" | rev | cut -d '/' -f -1 | rev);
		echo "Playing $track_id / $track_count // $filename";
		mpv "$url" $mpv_options;
	fi

	[ -f $state/die ] && break;
	[ -f $state/loop ] && continue;

	# Increment track id 
	track_id=$(cat $state/track_id);
	track_id=$((track_id+1));
	echo $track_id > $state/track_id;
done;

rm $state/die;
rm $state/pipe;

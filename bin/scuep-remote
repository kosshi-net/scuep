#!/bin/sh
state="$HOME/.config/scuep";


line_exists () {
	while read line; do
		if [ "$line" = "$1" ]; then 
			return 1;
		fi
	done < "$2"
	return 0
}


if [ ! -p "$state/pipe" ]; then
	echo "No pipe";
	exit 1;
fi

if		[ "$1" = "play" ] || 
		[ "$1" = "stop" ] || 
		[ "$1" = "pause" ]; then

		echo "cycle pause" >> $state/pipe

elif  	[ "$1" = "next" ] ||
		[ "$1" = "skip" ]; then

		echo "quit" >> $state/pipe;

elif  	[ "$1" = "quit" ] ||
		[ "$1" = "exit" ] ||
		[ "$1" = "kill" ]; then

		touch $state/die;
		echo "quit" >> $state/pipe;

elif 	[ "$1" = "prev" ]; then

		line=$(cat $state/track_id);
		line=$((line-2));
		echo $line > $state/track_id;
		echo "quit" >> $state/pipe;

elif 	[ "$1" = "addto" ]; then

		if [ -z "$2" ]; then
			echo "Usage: $0 $1 path";
			exit 1;
		fi

		touch "$2";
		url=$(cat "$state/current_url");

		while read line; do
			if [ "$line" = "$url" ]; then 
				echo "Track already exists in destination";
				exit 1;
			fi
		done < "$2"
		echo "$url" >> "$2";
		
elif 	[ "$1" = "exists" ]; then

		if [ -z "$2" ]; then
			echo "Usage: $0 $1 path";
			exit 1;
		fi

		url=$(cat "$state/current_url");
		line_exists "$url" "$2";
		
		return $?


elif 	[ "$1" = "current_url" ]; then

		cat $state/current_url;

elif 	[ "$1" = "set-volume" ]; then

		if [ -z "$2" ]; then
			echo "Usage: set-volume 0-100";
			exit 1;
		fi


		echo "volume -$(cat $state/volume)" > $state/pipe;
		echo "$2" > $state/volume;
		
		# Change volume of current mpv session
		# This is dumb, but it works
		echo "volume $2" > $state/pipe;

elif 	[ "$1" = "seek" ]; then

		if [ -z "$2" ]; then
			echo "Usage: seek seconds";
			exit 1;
		fi
		echo "seek $2" >> $state/pipe;

else
		echo "Usage: ";
		echo "  Basic controls:";
		echo "   $0 <pause/next/prev>";
		echo "  Echo url of currently playing file:";
		echo "   $0 current_url";
		echo "  Add currently playing song to a playlist:";
		echo "   $0 addto <path>";
		echo "  Kill the server:";
		echo "   $0 quit";
		echo "  Seek:";
		echo "   $0 seek seconds";
		echo "  Volume:";
		echo "   $0 set-volume 0-100";
fi
